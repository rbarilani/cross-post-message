(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.CrossPostMessageHub=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Window=require("./Window");var Response=require("./Response");var Util=require("./Util");var WindowChannel=require("./WindowChannel");var HubStatus=require("./HubStatus");var Hub=function(){function Hub(opt){_classCallCheck(this,Hub);var _opt=opt||{};this._debug=_opt.debug||false;this._allowedOrigins=_opt.allowedOrigins||[];this._definitions=[];this._client=new WindowChannel(window.parent);this._client.postMessage(HubStatus.READY);installListener.call(this)}_createClass(Hub,[{key:"when",value:function when(method,uri,cb){this._definitions.push({method:method,uri:uri,cb:cb});return this}}]);return Hub}();module.exports=Hub;function installListener(){var _this=this;Window.addEventListener("message",function(e){if(_this._debug){console.log("hub receive a message",e)}if(!checkOrigin.call(_this,e.origin)){console.warn("cross-post-message-hub. Origin is not allowed. skip message");return}try{var request=JSON.parse(e.data)}catch(e){console.error(e)}if(request&&request.event==="request"){onRequest.call(_this,request,e)}},true)}function onRequest(request,e){var _this2=this;var response;var definition=Util.find(this._definitions,function(definition){if(definition.method===request.method&&definition.uri===request.uri){return definition}});if(!definition){response=new Response(request,{status:404,body:new Error("Definition not found")});this._client.postMessage(response,e.origin);return}var promise=new Promise(function(resolve,reject){try{definition.cb(request,resolve,reject)}catch(e){reject(new Response(request,{status:500,body:e}))}});promise.then(function(definitionResponse){var response;if(typeof definitionResponse==="string"){response=new Response(request,{status:200,body:definitionResponse})}else{response=new Response(request,definitionResponse)}_this2._client.postMessage(response,e.origin)}).catch(function(definitionResponse){var response;if(typeof definitionResponse==="string"){response=new Response(request,{status:500,body:new Error(definitionResponse)})}else{response=new Response(request,definitionResponse)}if(Util.isSuccessHttpStatus(response.status)){response.status=500}_this2._client.postMessage(response,e.origin)})}function checkOrigin(origin){if(!this._allowedOrigins.length){return true}return this._allowedOrigins.indexOf(origin)>-1}},{"./HubStatus":2,"./Response":4,"./Util":5,"./Window":6,"./WindowChannel":7}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var HubStatus={READY:"ready"};exports.default=HubStatus},{}],3:[function(require,module,exports){"use strict";module.exports=window.Math},{}],4:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Util=require("./Util");var Response=function Response(request,attributes){_classCallCheck(this,Response);Util.extend(this,attributes||{});this.event="response";this.request=request};module.exports=Response},{"./Util":5}],5:[function(require,module,exports){"use strict";var Math=require("./Math");var Util={generateUUID:function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})},isSuccessHttpStatus:function isSuccessHttpStatus(status){return 200<=status&&status<400},find:function find(collection,cb,$this){var found=undefined;$this=$this||undefined;for(var i=0;i<=collection.length;i++){found=cb.call($this,collection[i],i,collection);if(found){return found}}return found},extend:function extend(source,target){for(var prop in target){if(target.hasOwnProperty(prop)){source[prop]=target[prop]}}return source}};module.exports=Util},{"./Math":3}],6:[function(require,module,exports){"use strict";module.exports=window},{}],7:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var WindowChannel=function(){function WindowChannel(source){_classCallCheck(this,WindowChannel);this.source=source}_createClass(WindowChannel,[{key:"postMessage",value:function postMessage(message,targetOrigin,transfer){var _message=typeof message==="string"?message:JSON.stringify(message);this.source.postMessage(_message,targetOrigin||"*",transfer)}}]);return WindowChannel}();module.exports=WindowChannel},{}]},{},[1])(1)});
